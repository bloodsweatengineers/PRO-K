#include "waveform.h"

static uint8_t wave[256] = {
	128,131,134,137,141,144,147,150,153,156,159,162,165,168,171,174,177,180,
	183,186,188,191,194,196,199,202,204,207,209,212,214,216,219,221,223,225,
	227,229,231,233,234,236,238,239,241,242,244,245,246,247,249,250,250,251,
	252,253,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,254,
	254,253,252,251,250,250,249,247,246,245,244,242,241,239,238,236,234,233,
	231,229,227,225,223,221,219,216,214,212,209,207,204,202,199,196,194,191,
	188,186,183,180,177,174,171,168,165,162,159,156,153,150,147,144,141,137,
	134,131,128,125,122,119,115,112,109,106,103,100,97,94,91,88,85,82,79,76,
	73,70,68,65,62,60,57,54,52,49,47,44,42,40,37,35,33,31,29,27,25,23,22,20,
	18,17,15,14,12,11,10,9,7,6,6,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,
	5,6,6,7,9,10,11,12,14,15,17,18,20,22,23,25,27,29,31,33,35,37,40,42,44,47,
	49,52,54,57,60,62,65,68,70,73,76,79,82,85,88,91,94,97,100,103,106,109,112,
	115,119,122,125
};

static uint8_t amplitude_corrected_wave_1[256] = {
	128,131,134,137,141,144,147,150,153,156,159,162,165,168,171,174,177,180,
	183,186,188,191,194,196,199,202,204,207,209,212,214,216,219,221,223,225,
	227,229,231,233,234,236,238,239,241,242,244,245,246,247,249,250,250,251,
	252,253,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,254,
	254,253,252,251,250,250,249,247,246,245,244,242,241,239,238,236,234,233,
	231,229,227,225,223,221,219,216,214,212,209,207,204,202,199,196,194,191,
	188,186,183,180,177,174,171,168,165,162,159,156,153,150,147,144,141,137,
	134,131,128,125,122,119,115,112,109,106,103,100,97,94,91,88,85,82,79,76,
	73,70,68,65,62,60,57,54,52,49,47,44,42,40,37,35,33,31,29,27,25,23,22,20,
	18,17,15,14,12,11,10,9,7,6,6,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,
	5,6,6,7,9,10,11,12,14,15,17,18,20,22,23,25,27,29,31,33,35,37,40,42,44,47,
	49,52,54,57,60,62,65,68,70,73,76,79,82,85,88,91,94,97,100,103,106,109,112,
	115,119,122,125
};

static uint8_t amplitude_corrected_wave_2[256] = {
	128,131,134,137,141,144,147,150,153,156,159,162,165,168,171,174,177,180,
	183,186,188,191,194,196,199,202,204,207,209,212,214,216,219,221,223,225,
	227,229,231,233,234,236,238,239,241,242,244,245,246,247,249,250,250,251,
	252,253,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,254,
	254,253,252,251,250,250,249,247,246,245,244,242,241,239,238,236,234,233,
	231,229,227,225,223,221,219,216,214,212,209,207,204,202,199,196,194,191,
	188,186,183,180,177,174,171,168,165,162,159,156,153,150,147,144,141,137,
	134,131,128,125,122,119,115,112,109,106,103,100,97,94,91,88,85,82,79,76,
	73,70,68,65,62,60,57,54,52,49,47,44,42,40,37,35,33,31,29,27,25,23,22,20,
	18,17,15,14,12,11,10,9,7,6,6,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,
	5,6,6,7,9,10,11,12,14,15,17,18,20,22,23,25,27,29,31,33,35,37,40,42,44,47,
	49,52,54,57,60,62,65,68,70,73,76,79,82,85,88,91,94,97,100,103,106,109,112,
	115,119,122,125
};

uint8_t static phaseshift[4] = {0, 0, 0, 0};
uint8_t static amplitude[2] = {0, 0};
uint8_t static vfd_enable = 0;
uint16_t static target = 0;
uint16_t static current = 0;

void calc_amplitude() {
	for(int i=0; i<256; i++) {
		int16_t amp = (int16_t)wave[i] - 128;

		amplitude_corrected_wave_1[i] = (uint8_t)(((amplitude[0] * amp) / 100) + 128);
		amplitude_corrected_wave_2[i] = (uint8_t)(((amplitude[1] * amp) / 100) + 128);
	}
}

ISR(TIMER1_COMPA_vect) {

	static volatile uint8_t index = 0;

	OCR0A = amplitude_corrected_wave_1[(index + phaseshift[0]) % 256];
	OCR0B = amplitude_corrected_wave_1[(index + phaseshift[1]) % 256];
	OCR2A = amplitude_corrected_wave_1[(index + phaseshift[2]) % 256];

	OCR2B = amplitude_corrected_wave_2[(index + phaseshift[3]) % 256];

	index++;

	if(vfd_enable) {
		if(current < target) {
			current++;
		} else if(current > target) {
			current--;
		} else if(current == target) {
			vfd_enable = 0;
		}

		OCR1A = current;
	}
}

void frequency_execute(struct config *conf) {
	if(conf->vfd_enable) {
		target = conf->frequency_clicks;
		current = OCR1A;
		vfd_enable = 1;
	}else {
		OCR1A = conf->frequency_clicks;
	}

	conf->vfd_enable = 0;

	TCCR1B &= 0xF8;
	TCCR1B |= (conf->frequency_prescaler_index & 0x07);
}

void phaseshift_execute(struct config *conf) {
	for(int i=0; i<4; i++) {
		phaseshift[i] = conf->phaseshift_clicks[i];
	}
} 

void amplitude_execute(struct config *conf) {
	amplitude[0] = conf->amplitude[0];
	amplitude[1] = conf->amplitude[1];
	
	calc_amplitude();
}

void pwm_frequency_execute(struct config *conf) {
	TCCR2B &= 0xF1;
	TCCR0B &= 0xF1;
	TCCR2B |= conf->pwm_frequency_prescaler_index & 0x07;
	TCCR0B |= conf->pwm_frequency_prescaler_index & 0x07;
}

void enable_execute(struct config *conf) {
	TCCR2A &= ~(1 << COM2A1 | 1<<COM2B1);
	TCCR0A &= ~(1 << COM0A1 | 1<<COM0B1);

	if(conf->enable[0] == 1) {
		TCCR2A |= (1 << COM2A1);
	}

	if(conf->enable[1] == 1) {
		TCCR2A |= (1 << COM2B1);
	}

	if(conf->enable[2] == 1) {
		TCCR0A |= (1 << COM0A1);
	}

	if(conf->enable[3] == 1) {
		TCCR0A |= (1 << COM0B1);
	}
}

void execute_all(struct config *conf) {
	frequency_execute(conf);
	phaseshift_execute(conf);
	amplitude_execute(conf);
	pwm_frequency_execute(conf);
	enable_execute(conf);
}
