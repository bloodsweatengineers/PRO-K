#include "waveform.h"

static uint8_t wave[256] = {
	128,131,134,137,141,144,147,150,153,156,159,162,165,168,171,174,177,180,
	183,186,188,191,194,196,199,202,204,207,209,212,214,216,219,221,223,225,
	227,229,231,233,234,236,238,239,241,242,244,245,246,247,249,250,250,251,
	252,253,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,254,
	254,253,252,251,250,250,249,247,246,245,244,242,241,239,238,236,234,233,
	231,229,227,225,223,221,219,216,214,212,209,207,204,202,199,196,194,191,
	188,186,183,180,177,174,171,168,165,162,159,156,153,150,147,144,141,137,
	134,131,128,125,122,119,115,112,109,106,103,100,97,94,91,88,85,82,79,76,
	73,70,68,65,62,60,57,54,52,49,47,44,42,40,37,35,33,31,29,27,25,23,22,20,
	18,17,15,14,12,11,10,9,7,6,6,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,
	5,6,6,7,9,10,11,12,14,15,17,18,20,22,23,25,27,29,31,33,35,37,40,42,44,47,
	49,52,54,57,60,62,65,68,70,73,76,79,82,85,88,91,94,97,100,103,106,109,112,
	115,119,122,125
};

static uint8_t amplitude_corrected_wave[256] = {
	128,131,134,137,141,144,147,150,153,156,159,162,165,168,171,174,177,180,
	183,186,188,191,194,196,199,202,204,207,209,212,214,216,219,221,223,225,
	227,229,231,233,234,236,238,239,241,242,244,245,246,247,249,250,250,251,
	252,253,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,254,
	254,253,252,251,250,250,249,247,246,245,244,242,241,239,238,236,234,233,
	231,229,227,225,223,221,219,216,214,212,209,207,204,202,199,196,194,191,
	188,186,183,180,177,174,171,168,165,162,159,156,153,150,147,144,141,137,
	134,131,128,125,122,119,115,112,109,106,103,100,97,94,91,88,85,82,79,76,
	73,70,68,65,62,60,57,54,52,49,47,44,42,40,37,35,33,31,29,27,25,23,22,20,
	18,17,15,14,12,11,10,9,7,6,6,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,
	5,6,6,7,9,10,11,12,14,15,17,18,20,22,23,25,27,29,31,33,35,37,40,42,44,47,
	49,52,54,57,60,62,65,68,70,73,76,79,82,85,88,91,94,97,100,103,106,109,112,
	115,119,122,125
};

/*
static uint8_t wave[256] = {
	128,131,134,137,140,143,146,149,152,155,158,161,164,167,
	170,173,176,179,182,185,187,190,193,195,198,201,203,206,
	208,210,213,215,217,219,222,224,226,228,230,231,233,235,
	236,238,240,241,242,244,245,246,247,248,249,250,251,251,
	252,253,253,254,254,254,254,254,255,254,254,254,254,254,
	253,253,252,251,251,250,249,248,247,246,245,244,242,241,
	240,238,236,235,233,231,230,228,226,224,222,219,217,215,
	213,210,208,206,203,201,198,195,193,190,187,185,182,179,
	176,173,170,167,164,161,158,155,152,149,146,143,140,137,
	134,131,128,124,121,118,115,112,109,106,103,100,97,94,91,
	88,85,82,79,76,73,70,68,65,62,60,57,54,52,49,47,45,42,40,38,
	36,33,31,29,27,25,24,22,20,19,17,15,14,13,11,10,9,8,7,6,5,4,
	4,3,2,2,1,1,1,1,1,1,1,1,1,1,1,2,2,3,4,4,5,6,7,8,9,10,11,13,
	14,15,17,19,20,22,24,25,27,29,31,33,36,38,40,42,45,47,49,52,
	54,57,60,62,65,68,70,73,76,79,82,85,88,91,94,97,100,103,
	106,109,112,115,118,121,124
};

static uint8_t amplitude_corrected_wave[256] = {
	128,131,134,137,140,143,146,149,152,155,158,161,164,167,
	170,173,176,179,182,185,187,190,193,195,198,201,203,206,
	208,210,213,215,217,219,222,224,226,228,230,231,233,235,
	236,238,240,241,242,244,245,246,247,248,249,250,251,251,
	252,253,253,254,254,254,254,254,255,254,254,254,254,254,
	253,253,252,251,251,250,249,248,247,246,245,244,242,241,
	240,238,236,235,233,231,230,228,226,224,222,219,217,215,
	213,210,208,206,203,201,198,195,193,190,187,185,182,179,
	176,173,170,167,164,161,158,155,152,149,146,143,140,137,
	134,131,128,124,121,118,115,112,109,106,103,100,97,94,91,
	88,85,82,79,76,73,70,68,65,62,60,57,54,52,49,47,45,42,40,38,
	36,33,31,29,27,25,24,22,20,19,17,15,14,13,11,10,9,8,7,6,5,4,
	4,3,2,2,1,1,1,1,1,1,1,1,1,1,1,2,2,3,4,4,5,6,7,8,9,10,11,13,
	14,15,17,19,20,22,24,25,27,29,31,33,36,38,40,42,45,47,49,52,
	54,57,60,62,65,68,70,73,76,79,82,85,88,91,94,97,100,103,
	106,109,112,115,118,121,124
};

static uint8_t wave[256] = {
	128,131,134,137,140,143,146,149,152,156,159,162,165,168,
	171,174,176,179,182,185,188,191,193,196,199,201,204,206,
	209,211,213,216,218,220,222,224,226,228,230,232,234,236,
	237,239,240,242,243,245,246,247,248,249,250,251,252,252,
	253,254,254,255,255,255,255,255,255,255,255,255,255,255,
	254,254,253,252,252,251,250,249,248,247,246,245,243,242,
	240,239,237,236,234,232,230,228,226,224,222,220,218,216,
	213,211,209,206,204,201,199,196,193,191,188,185,182,179,
	176,174,171,168,165,162,159,156,152,149,146,143,140,137,
	134,131,128,124,121,118,115,112,109,106,103,99,96,93,90,
	87,84,81,79,76,73,70,67,64,62,59,56,54,51,49,46,44,42,39,
	36,35,33,31,29,27,25,23,21,19,18,16,15,13,12,10,9,8,7,6,5,
	4,3,2,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,2,3,3,4,5,6,7,8,9,10,
	12,13,15,16,18,19,21,23,25,27,29,31,35,37,39,42,44,46,49,
	51,54,56,59,62,64,67,70,73,76,79,81,84,87,90,93,96,99,103,
	106,109,112,115,118,121,124
};
*/

uint8_t static phaseshift[4] = {0, 0, 0, 0};

ISR(TIMER1_COMPA_vect) {

	static volatile uint8_t index = 0;

	OCR0A = amplitude_corrected_wave[(index + phaseshift[0]) % 256];
	OCR0B = amplitude_corrected_wave[(index + phaseshift[1]) % 256];
	OCR2A = amplitude_corrected_wave[(index + phaseshift[2]) % 256];
	OCR2B = amplitude_corrected_wave[(index + phaseshift[3]) % 256];

	index++;
}

void frequency_conf(struct config *conf, int32_t value, int8_t channel) {

	uint8_t possible_prescalers[] = {0,3,6,8,10};
	uint8_t size = 5;

	uint8_t index = 1;
	uint32_t clicks = F_CPU_10M / (value << 8);

	while (clicks > (uint32_t)UINT16_MAX) {
		clicks >>= possible_prescalers[index];
		index++;
	}

	conf->frequency = value;
	conf->frequency_prescaler_index = index;
	conf->frequency_clicks = clicks;
}

void frequency_execute(struct config *conf) {
	OCR1A = conf->frequency_clicks;
	TCCR1B &= 0xF8;
	TCCR1B |= (conf->frequency_prescaler_index & 0x07);
}

void phaseshift_conf(struct config *conf, uint8_t value, int8_t channel) {
	if(channel < 0) {
		for(int i=0; i<4; i++) {
			conf->phaseshift[i] = value;
			conf->phaseshift_clicks[i] = ((uint16_t)value<<8) / 360;
		}
	} else {
		conf->phaseshift[channel] = value;
		conf->phaseshift_clicks[channel] = ((uint16_t)value<<8) / 360;
	}
}

void phaseshift_execute(struct config *conf) {
	for(int i=0; i<4; i++) {
		phaseshift[i] = conf->phaseshift_clicks[i];
	}
} 

void amplitude_conf(struct config *conf, uint8_t value, int8_t channel) {
	cli();
	for(int i=0; i<256; i++) {
		amplitude_corrected_wave[i] = (value*(wave[i] - 128) + 12800)/100;
	}
	sei();
}

void amplitude_execute(struct config *conf) {
}
